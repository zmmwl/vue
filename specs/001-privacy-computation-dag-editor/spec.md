# Feature Specification: 隐私计算任务可视化拖拽编辑器

**Feature Branch**: `001-privacy-computation-dag-editor`
**Created**: 2026-01-16
**Status**: Draft
**Input**: User description: "我的需求规范在.myprompt/prod.md"

## Clarifications

### Session 2026-01-16

- Q: 资源库中的元数据（数据资源、模型资源、算力资源）通过什么方式提供？ → A: 纯前端应用，元数据通过本地配置或静态文件提供
- Q: 是否需要在规格中明确定义导出/导入JSON的schema？ → A: 不在规格中定义具体schema，由实现时自行决定结构
- Q: 导入JSON格式错误时，错误提示应显示什么级别详情？ → A: 显示具体错误详情（如缺少字段、类型不匹配等）
- Q: 关闭任务图tab后的行为是什么？ → A: 关闭tab仅隐藏，未刷新页面时可重新打开
- Q: 项目的技术栈选择是什么？ → A: Vue 3 + TypeScript + Element Plus

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 创建和编排DAG任务图 (Priority: P1)

隐私计算用户通过可视化的拖拽界面，从资源库中选择数据资源、计算任务、模型资源和算力资源，在中央画布中通过拖拽、连线的方式构建隐私计算任务图（DAG），实现跨域隐私计算任务的可视化编排。

**Why this priority**: 这是产品的核心功能，是用户使用该工具的主要目的，没有这个功能用户无法构建任何隐私计算任务。

**Independent Test**: 用户可以独立测试在画布中拖拽元素并连接它们形成简单的工作流，不依赖其他功能。

**Acceptance Scenarios**:

1. **Given** 用户打开应用，**When** 从资源库拖拽数据资源到画布，**Then** 资源以圆形显示在画布顶端
2. **Given** 画布中有数据资源，**When** 从资源库拖拽计算任务到画布，**Then** 任务以圆角长方形显示
3. **Given** 画布中有数据资源和计算任务，**When** 从数据资源连线到计算任务，**Then** 连线以有向箭头显示
4. **Given** 画布中有计算任务，**When** 将模型资源拖拽到计算任务上，**Then** 模型以菱形附着点连接到任务
5. **Given** 画布中有计算任务，**When** 将算力资源拖拽到计算任务上，**Then** 算力附着到任务
6. **Given** 画布中有多个元素，**When** 点击某个元素，**Then** 该元素的属性显示在右侧详情表单中

---

### User Story 2 - 导出和导入任务图 (Priority: P2)

用户可以将编排好的任务图导出为JSON格式文件保存，也可以从JSON文件导入任务图并在新tab页中展示，实现任务图的保存和恢复。

**Why this priority**: 这是用户保存工作成果和分享任务图的必要功能，让任务可以被持久化和重用。

**Independent Test**: 用户可以独立测试导出功能，生成JSON文件，然后导入该文件验证任务图正确恢复。

**Acceptance Scenarios**:

1. **Given** 画布中有编排好的任务图，**When** 点击导出按钮，**Then** 生成包含任务图所有信息的JSON文件
2. **Given** 用户选择JSON文件导入，**When** 导入成功，**Then** 在新tab页中显示完整的任务图
3. **Given** 导入的JSON文件包含多个资源连接，**When** 导入完成，**Then** 所有连接关系正确显示

---

### User Story 3 - 管理多个任务图 (Priority: P2)

用户可以创建多个新任务图，每个任务图在一个独立的tab页中显示，可以切换查看不同的任务图。

**Why this priority**: 用户需要同时处理多个隐私计算任务，多个tab页可以提高工作效率。

**Independent Test**: 用户可以独立测试创建多个任务图tab，切换和查看不同tab内容。

**Acceptance Scenarios**:

1. **Given** 用户已有一个任务图，**When** 点击创建新任务图，**Then** 新tab页显示空白画布
2. **Given** 有多个tab页，**When** 点击不同tab，**Then** 显示对应的任务图内容
3. **Given** 有多个tab页，**When** 关闭某个tab，**Then** 该tab被移除，其他tab继续显示

---

### User Story 4 - 编辑元素属性 (Priority: P3)

用户点击画布中的任何元素后，可以在右侧详情表单中查看和编辑该元素的元信息属性，实现任务图元素的配置。

**Why this priority**: 这是用户对任务图进行细化和配置的重要功能，确保任务参数符合业务需求。

**Independent Test**: 用户可以独立测试点击元素、查看属性、修改属性并保存。

**Acceptance Scenarios**:

1. **Given** 画布中有数据资源，**When** 点击该资源，**Then** 右侧表单显示其名称、字段、主键等属性
2. **Given** 元素属性显示在表单中，**When** 修改某个属性值，**Then** 修改被保存并反映在元素上
3. **Given** 表单有必填字段，**When** 留空必填字段，**Then** 显示验证错误提示

---

### Edge Cases

- 当用户尝试从非数据资源元素开始连线时，系统应提示必须从数据资源开始
- 当任务图中缺少必要的输入或输出连接时，系统应显示警告
- 当导入的JSON文件格式不正确时，系统应显示具体错误详情（如缺少必需字段、类型不匹配等）并阻止导入
- 当画布中元素过多导致重叠时，系统应支持缩放和平移操作
- 当用户删除任务图中的某个元素时，相关的连线也应被删除
- 当用户关闭某个tab后，该tab的状态在当前session期间保留，页面刷新后丢失

## Requirements *(mandatory)*

### Functional Requirements

#### 资源库功能

- **FR-001**: 系统必须提供一个可折叠的层级资源库，包含数据资源、计算任务资源、模型资源和算力资源，元数据通过本地配置或静态文件提供
- **FR-002**: 数据资源必须按参与方分组显示，每个数据资源包含名称、来源方、字段及类型、主键字段、数据规模等元信息
- **FR-003**: 计算任务资源必须分为隐私计算任务（PSI、MPC、PIR、FL）和本地计算任务（数据导入、数据导出、数据过滤、数据拼接）
- **FR-004**: 模型资源（TEE模型）必须显示方法名称、方法参数及类型、返回参数及类型等元信息
- **FR-005**: 算力资源（TEE算力）必须按参与方分类显示

#### 中央画布功能

- **FR-006**: 画布必须支持将资源库中的元素拖拽到画布上
- **FR-007**: 数据资源必须以圆形显示，计算任务以圆角长方形显示，模型资源以圆角正方形显示
- **FR-008**: 画布必须采用泳道布局，横向按参与方划分域，纵向为数据流向（自上而下）
- **FR-009**: 数据资源必须只能放置在画布顶端区域
- **FR-010**: 数据导出任务必须只能放置在画布底端区域
- **FR-011**: 元素之间必须支持连线操作，连线代表数据资源流向
- **FR-012**: 连线必须根据数据流向显示不同的线端形状（输入用箭头，输出用梯形）
- **FR-013**: 每个计算任务的上边缘必须为输入连接点，下边缘为输出连接点
- **FR-014**: 每个计算任务必须支持附着多个数据模型，模型共用一个菱形附着点
- **FR-015**: 每个计算任务只能附着一个算力资源
- **FR-016**: 画布必须支持缩放和平移操作
- **FR-017**: 画布必须支持删除元素及其相关连线

#### 详情表单功能

- **FR-018**: 系统必须在用户点击画布元素时，在右侧表单中显示该元素的所有可编辑属性
- **FR-019**: 表单必须支持用户编辑并保存元素的属性
- **FR-020**: 表单必须对必填字段进行验证
- **FR-021**: 表单修改必须实时反映到画布中的元素上

#### 任务图管理功能

- **FR-022**: 系统必须支持创建新任务图，在新的tab页中显示空白画布
- **FR-023**: 系统必须支持多个任务图tab的切换
- **FR-024**: 系统必须支持关闭任务图tab，关闭的tab仅在当前session期间可重新打开，页面刷新后丢失
- **FR-025**: 系统必须支持将当前任务图导出为JSON格式文件
- **FR-026**: 系统必须支持从JSON文件导入任务图并在新tab页中显示
- **FR-027**: 导出的JSON文件必须包含任务图中所有元素、连线、属性的完整信息
- **FR-028**: 导入时必须验证JSON文件格式的正确性

#### UI/UX要求

- **FR-029**: 任务图的整体视觉风格必须参考指定的DAG样例图片
- **FR-030**: 界面必须采用左（资源库）、中（画布）、右（详情表单）三栏布局
- **FR-031**: 资源库必须支持展开/收起操作
- **FR-032**: 画布元素必须有明显的选中状态指示
- **FR-033**: 连线必须有明显的连接点显示，方便用户进行连接操作

### Key Entities

- **任务图（Task Graph）**: 代表一个完整的隐私计算DAG任务图，包含多个元素和连线关系
- **画布元素（Canvas Element）**: 可以是数据资源、计算任务、模型资源或算力资源，具有位置、属性和类型
- **数据资源（Data Resource）**: 代表数据库表或文件，包含名称、来源方、字段定义、主键、规模等元信息
- **计算任务（Compute Task）**: 代表隐私计算或本地计算操作，可以有多个输入输出连接，可附着模型和算力
- **模型资源（Model Resource）**: 代表TEE模型，包含方法名称、参数定义等
- **算力资源（Compute Resource）**: 代表TEE算力，属于特定参与方
- **连线（Connection）**: 代表数据流向，有起点和终点，有线端形状
- **参与方（Participant）**: 隐私计算的参与方，用于划分泳道域

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户可以在5分钟内创建一个包含至少3个数据资源和2个计算任务的简单DAG任务图
- **SC-002**: 系统支持至少50个元素（数据资源+计算任务）在同一画布中流畅操作，无明显卡顿
- **SC-003**: 任务图导出和导入操作在3秒内完成（包含100个元素的复杂任务图）
- **SC-004**: 90%的用户在第一次使用时能够成功创建一个有效的DAG任务图
- **SC-005**: 用户可以同时管理至少10个不同的任务图（10个tab页）
- **SC-006**: 画布缩放和拖拽操作响应时间不超过200毫秒
- **SC-007**: 95%的连线操作能够在首次尝试中成功连接到目标元素

### Constraints & Tradeoffs

- **C-001**: 系统采用纯前端架构，元数据通过本地配置或静态文件提供，无需后端API依赖
- **C-002**: 任务图以JSON格式持久化，支持本地文件导出和导入
- **C-003**: 技术栈采用 Vue 3 + TypeScript + Element Plus
